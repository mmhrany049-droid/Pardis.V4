<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8" />
<title>Ø²Ø¨Ø§Ù† Ø¨Ø§ÛŒÙ†Ø±ÛŒ Ù¾Ø§Ø±Ø¯ÛŒØ³ â€” Ù†Ø³Ø®Ù‡ Ú†Ù‡Ø§Ø±Ù…</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&family=Poppins:wght@400;600&family=Roboto+Mono&display=swap');
:root {
  color: #0f172a;
  font-family: 'Vazirmatn', 'Poppins', 'Roboto Mono', monospace, sans-serif;
}
body {
  margin: 0;
  background: #0f172a;
  color: white;
  overflow-x: hidden;
  overflow-y: auto;
  text-align: center;
}
@keyframes headerAppear {
  0% { opacity: 0; transform: translateY(-30px) scale(0.95); text-shadow: none; }
  60% { opacity: 1; transform: translateY(0px) scale(1.05); text-shadow: 0 0 20px rgba(0,234,255,0.7); }
  100% { transform: scale(1); text-shadow: 0 0 15px rgba(0,234,255,0.7); }
}
@keyframes gradientShift {
  0% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
  100% { background-position: 0% 50%; }
}
.hidden { display: none !important; }
header {
  font-size: 40px;
  font-weight: 700;
  margin-top: 20px;
  margin-bottom: 10px;
  background: linear-gradient(270deg,#00eaff,#3b82f6,#a855f7,#06f3d4);
  background-size: 800% 800%;
  animation: headerAppear 1.6s ease-out forwards, gradientShift 6s ease infinite;
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  text-shadow: 0 0 15px rgba(0,234,255,0.7);
}
.app-container.hidden { display: none; }
.auth-overlay {
  position: fixed;
  inset: 0;
  background: rgba(15,23,42,0.96);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 2000;
  padding: 20px;
}
.auth-card {
  width: min(620px, 95%);
  background: rgba(17,24,39,0.85);
  border: 1px solid rgba(148,163,184,0.2);
  border-radius: 20px;
  padding: 32px 28px;
  box-shadow: 0 22px 55px rgba(2,6,23,0.75);
  display: flex;
  flex-direction: column;
  gap: 22px;
}
.auth-tabs {
  display: flex;
  gap: 12px;
}
.auth-tab {
  flex: 1;
  padding: 12px 0;
  border-radius: 11px;
  border: none;
  background: rgba(148,163,184,0.15);
  color: #e2e8f0;
  cursor: pointer;
  font-size: 17px;
  font-weight: 600;
  transition: background 0.3s ease, transform 0.15s ease;
  font-family: 'Vazirmatn','Poppins',sans-serif;
}
.auth-tab:hover { background: rgba(148,163,184,0.28); transform: translateY(-2px); }
.auth-tab.active {
  background: linear-gradient(90deg,#06b6d4,#3b82f6);
  box-shadow: 0 4px 22px rgba(59,130,246,0.36);
}
.auth-content {
  display: none;
  background: rgba(15,23,42,0.45);
  padding: 20px;
  border-radius: 14px;
  border: 1px dashed rgba(148,163,184,0.22);
  text-align: right;
}
.auth-content.active { display: block; }
.auth-content .panel-title {
  margin: 0 0 8px 0;
  font-size: 22px;
  font-weight: 700;
  text-align: center;
}
.auth-fields {
  display: flex;
  flex-direction: column;
  gap: 16px;
}
.auth-field {
  display: flex;
  flex-direction: column;
  gap: 6px;
}
.auth-field label {
  font-weight: 600;
  color: #cbd5f5;
}
.auth-field input {
  width: 100%;
  padding: 11px 12px;
  border-radius: 10px;
  border: 1px solid rgba(148,163,184,0.35);
  background: rgba(15,23,42,0.65);
  color: #f8fafc;
  font-family: 'Vazirmatn','Poppins',sans-serif;
}
.auth-field input:focus { outline: 2px solid rgba(59,130,246,0.6); }
.auth-submit {
  padding: 12px;
  font-size: 16px;
  font-weight: 600;
}
.auth-tip {
  font-size: 13px;
  color: #94a3b8;
  line-height: 1.6;
  text-align: justify;
}
.camera-instruct {
  border-top: 1px dashed rgba(148,163,184,0.25);
  margin-top: 8px;
  padding-top: 8px;
  font-size: 13px;
  color: #94a3b8;
}
.camera-instruct strong { color: #e5e7eb; }
.top-box {
  background: rgba(255,255,255,0.05);
  border-radius: 16px;
  backdrop-filter: blur(10px);
  box-shadow: 0 4px 25px rgba(0,0,0,0.6);
  width: min(720px, 92%);
  padding: 24px;
  display: flex;
  flex-direction: column;
  gap: 15px;
  margin: 40px auto 28px auto;
  direction: rtl;
}
textarea {
  width: 100%;
  font-size: 18px;
  padding: 12px;
  border-radius: 11px;
  border: none;
  resize: vertical;
  background: rgba(255,255,255,0.11);
  color: #fff;
  font-family: 'Vazirmatn','Poppins',sans-serif;
  text-align: center;
  direction: rtl;
}
.actions {
  display: flex;
  justify-content: center;
  gap: 10px;
  flex-wrap: wrap;
  direction: ltr;
}
button {
  flex: 1;
  min-width: 90px;
  padding: 11px;
  font-size: 16px;
  cursor: pointer;
  border: none;
  border-radius: 10px;
  background: linear-gradient(90deg,#06b6d4,#3b82f6);
  color: white;
  transition: transform 0.2s ease, box-shadow 0.2s ease;
  font-family: 'Poppins','Vazirmatn',sans-serif;
  font-weight: 600;
  letter-spacing: 0.5px;
}
button:hover { transform: scale(1.04); box-shadow: 0 0 12px rgba(59,130,246,0.8); }
.fixed-btn { flex: none !important; min-width: auto !important; }
.logout-btn {
  background: linear-gradient(90deg,#f97316,#ef4444);
  padding: 8px 18px;
}
.outline-btn {
  background: transparent;
  border: 1px solid rgba(59,130,246,0.55);
  color: #bae6fd;
}
#outputBox {
  min-height: 70px;
  background: rgba(15,23,42,0.6);
  border-radius: 12px;
  padding: 14px;
  direction: rtl;
  text-align: center;
  color: #f1f5f9;
  font-size: 17px;
}
.app-container {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 30px;
  padding-bottom: 60px;
}
.app-top {
  display: flex;
  justify-content: space-between;
  align-items: center;
  width: min(960px, 92%);
  margin-top: 20px;
}
.user-meta-box {
  display: flex;
  align-items: center;
  gap: 10px;
  background: rgba(15,23,42,0.55);
  padding: 10px 14px;
  border-radius: 11px;
  box-shadow: 0 4px 18px rgba(2,6,23,0.55);
}
#currentUserLabel {
  font-weight: 600;
  font-size: 16px;
}
/* ------------------ Ø§Ø³ØªÚ¯Ø§Ù†ÙˆÚ¯Ø±Ø§ÙÛŒ ------------------ */
.stego-box {
  width: 92%;
  max-width: 940px;
  margin: 30px auto;
  background: rgba(255,255,255,0.06);
  border-radius: 20px;
  padding: 28px;
  backdrop-filter: blur(10px);
  box-shadow: 0 15px 45px rgba(2,6,23,0.55);
  text-align: right;
}
.stego-box h2 {
  margin: 0 0 8px 0;
  font-size: 26px;
}
.stego-description {
  font-size: 15px;
  color: #cbd5f5;
  line-height: 1.9;
  text-align: justify;
  margin-bottom: 24px;
}
.stego-grid {
  display: flex;
  flex-wrap: wrap;
  gap: 20px;
  justify-content: space-between;
}
.stego-column {
  flex: 1;
  min-width: 260px;
  display: flex;
  flex-direction: column;
  gap: 16px;
  background: rgba(15,23,42,0.65);
  border-radius: 16px;
  padding: 20px;
  border: 1px solid rgba(148,163,184,0.28);
}
textarea.stego-textarea {
  text-align: right;
  direction: rtl;
  min-height: 140px;
}
textarea.stego-result {
  text-align: right;
  direction: rtl;
  min-height: 120px;
}
.stego-result {
  display: flex;
  flex-direction: column;
  gap: 12px;
  align-items: center;
}
.stego-result img {
  max-width: 100%;
  border-radius: 12px;
  box-shadow: 0 10px 25px rgba(15,23,42,0.55);
}
.download-link {
  color: #38bdf8;
  text-decoration: none;
  font-weight: 600;
}
/* ------------------ Ù¾Ù†Ù„ Ø³Ø§Ø²Ù†Ø¯Ù‡ ------------------ */
.creator-panel {
  width: 92%;
  max-width: 960px;
  margin: 30px auto 60px auto;
  background: rgba(255,255,255,0.06);
  border-radius: 20px;
  padding: 28px;
  box-shadow: 0 15px 40px rgba(2,6,23,0.55);
  text-align: right;
  display: none;
  flex-direction: column;
  gap: 24px;
}
.creator-panel.visible { display: flex; }
.creator-panel h3 {
  margin: 0 0 14px 0;
}
.creator-panel form {
  display: flex;
  flex-wrap: wrap;
  gap: 12px;
  align-items: center;
  justify-content: flex-start;
}
.creator-panel form input,
.creator-panel form select {
  flex: 1;
  min-width: 190px;
  padding: 10px;
  border-radius: 9px;
  border: 1px solid rgba(148,163,184,0.3);
  background: rgba(15,23,42,0.65);
  color: #f8fafc;
}
.creator-panel form label {
  font-weight: 600;
  color: #f1f5f9;
  width: 100%;
}
.creator-user-list {
  display: grid;
  gap: 18px;
}
.user-card {
  display: flex;
  flex-direction: column;
  gap: 10px;
  border-radius: 14px;
  padding: 16px;
  background: rgba(15,23,42,0.6);
  border: 1px solid rgba(148,163,184,0.3);
}
.user-card .card-head {
  display: flex;
  align-items: center;
  justify-content: space-between;
}
.user-card .role {
  font-size: 13px;
  background: rgba(59,130,246,0.25);
  padding: 4px 10px;
  border-radius: 999px;
}
.user-card .pending {
  background: rgba(234,179,8,0.28);
  color: #facc15;
}
.user-card .meta {
  font-size: 13px;
  color: #cbd5f5;
  display: flex;
  flex-wrap: wrap;
  gap: 16px;
}
.user-card button {
  flex: none;
  min-width: 150px;
}
.assistant-box {
  background: rgba(30,41,59,0.75);
  border-radius: 16px;
  padding: 18px;
  border: 1px dashed rgba(148,163,184,0.4);
  display: flex;
  flex-direction: column;
  gap: 10px;
}
.assistant-box h4 {
  margin: 0;
  font-size: 20px;
}
.assistant-box ul {
  margin: 0;
  padding-right: 18px;
  list-style: 'â¤ ';
  color: #cbd5f5;
  font-size: 14px;
  display: flex;
  flex-direction: column;
  gap: 6px;
}
.assistant-box .status-row {
  display: flex;
  flex-wrap: wrap;
  gap: 14px;
  font-size: 13px;
  color: #e0f2fe;
}
/* ------------------ Ø¯ÙˆØ±Ø¨ÛŒÙ† ------------------ */
.camera-panel {
  position: fixed;
  top: 20px;
  left: 20px;
  width: 320px;
  background: rgba(15,23,42,0.9);
  border-radius: 18px;
  box-shadow: 0 22px 45px rgba(2,6,23,0.75);
  padding: 16px;
  display: flex;
  flex-direction: column;
  gap: 12px;
  z-index: 1500;
}
.camera-panel.hidden { display: none; }
.camera-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  color: #e2e8f0;
  font-weight: 600;
}
.camera-header button {
  flex: none;
  min-width: auto;
  padding: 4px 10px;
  font-size: 13px;
  border-radius: 8px;
}
#liveVideo {
  width: 100%;
  border-radius: 14px;
  border: 1px solid rgba(148,163,184,0.35);
}
#cameraStatus {
  font-size: 13px;
  color: #94a3b8;
}
/* ------------------ ØªÙ†Ø¸ÛŒÙ…Ø§Øª ------------------ */
.settings-panel {
  position: fixed;
  inset: auto 20px 20px auto;
  width: 290px;
  max-height: 90vh;
  overflow-y: auto;
  background: rgba(15,23,42,0.92);
  border-radius: 20px;
  padding: 18px;
  box-shadow: 0 22px 45px rgba(2,6,23,0.75);
  border: 1px solid rgba(59,130,246,0.25);
  display: none;
  flex-direction: column;
  gap: 14px;
  text-align: right;
}
.settings-panel.show { display: flex; }
.settings-panel h3 {
  margin: 0 0 6px 0;
  text-align: center;
}
.settings-panel label {
  display: flex;
  flex-direction: column;
  gap: 6px;
  font-size: 13px;
  color: #e2e8f0;
}
.settings-panel input {
  padding: 7px 6px;
  border-radius: 9px;
  border: 1px solid rgba(148,163,184,0.3);
  background: rgba(15,23,42,0.7);
  color: #f8fafc;
}
.close-btn {
  background: rgba(185,28,28,0.35);
  border: 1px solid rgba(248,113,113,0.35);
  color: #fecaca;
  padding: 8px;
}
.gear-btn {
  position: fixed;
  bottom: 20px;
  left: 20px;
  width: 48px;
  height: 48px;
  background: linear-gradient(135deg,#1e293b,#0ea5e9);
  color: white;
  border-radius: 50%;
  display: grid;
  place-items: center;
  cursor: pointer;
  box-shadow: 0 18px 35px rgba(14,165,233,0.35);
  transition: transform 0.2s ease;
  z-index: 1600;
}
.gear-btn:hover { transform: rotate(12deg) scale(1.04); }
/* ------------------ Ø³Ù‡â€ŒØ¨Ø¹Ø¯ÛŒ ------------------ */
#bitScene {
  margin: 0 auto;
  border-radius: 14px;
  background: rgba(15,23,42,0.55);
  box-shadow: 0 10px 35px rgba(15,23,42,0.65);
}
#bitLight {
  margin: 20px auto 10px auto;
  display: flex;
  align-items: center;
  gap: 12px;
  justify-content: center;
}
.bit-circle {
  width: 14px;
  height: 14px;
  border-radius: 50%;
  background: rgba(255,255,255,0.25);
  box-shadow: 0 0 0 rgba(255,255,255,0);
  transition: all 0.3s ease;
}
.on-zero {
  background-color: #00eaff;
  box-shadow: 0 0 15px #00eaff;
}
.on-one {
  background-color: #ffff00;
  box-shadow: 0 0 15px #ffff00;
}
/* ------------------ ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ùˆ Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§ ------------------ */
.history-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 13px;
  color: #cbd5f5;
}
.history-table th, .history-table td {
  border-bottom: 1px solid rgba(148,163,184,0.18);
  padding: 8px 10px;
  text-align: right;
}
.history-table th {
  background: rgba(15,23,42,0.85);
  font-weight: 700;
}
.empty-hint {
  font-size: 13px;
  color: #94a3b8;
  padding: 6px 0;
}
/* ------------------ ÙˆØ§Ú©Ù†Ø´â€ŒÚ¯Ø±Ø§ ------------------ */
@media (max-width: 768px) {
  header { font-size: 32px; }
  .camera-panel { position: fixed; inset: auto 10px 10px 10px; width: auto; }
  .settings-panel { width: calc(100% - 40px); inset: auto 20px 90px 20px; }
  .app-top { flex-direction: column; gap: 14px; }
  .user-meta-box { align-self: stretch; justify-content: space-between; }
}
</style>
</head>
<body>
<div id="authOverlay" class="auth-overlay">
  <div class="auth-card">
    <h1>Ø²Ø¨Ø§Ù† Ø¨Ø§ÛŒÙ†Ø±ÛŒ Ù¾Ø§Ø±Ø¯ÛŒØ³</h1>
    <div class="auth-tabs">
      <button type="button" class="auth-tab active" data-tab="creatorLogin" onclick="switchAuthTab('creatorLogin')">ÙˆØ±ÙˆØ¯ Ø³Ø§Ø²Ù†Ø¯Ù‡</button>
      <button type="button" class="auth-tab" data-tab="userFaceLogin" onclick="switchAuthTab('userFaceLogin')">ÙˆØ±ÙˆØ¯ Ú©Ø§Ø±Ø¨Ø± Ø¹Ø§Ø¯ÛŒ</button>
    </div>
    <div class="auth-content active" data-content="creatorLogin">
      <h2 class="panel-title">ÙˆØ±ÙˆØ¯ Ø³Ø§Ø²Ù†Ø¯Ù‡</h2>
      <form id="creatorLoginForm" onsubmit="loginCreator(event)">
        <div class="auth-fields">
          <div class="auth-field">
            <label for="creatorLoginUsername">Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ</label>
            <input type="text" id="creatorLoginUsername" autocomplete="username" required />
          </div>
          <div class="auth-field">
            <label for="creatorLoginPassword">Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±</label>
            <input type="password" id="creatorLoginPassword" autocomplete="current-password" required />
          </div>
        </div>
        <p class="auth-tip">Ø³Ø§Ø²Ù†Ø¯Ù‡ Ù…Ø§Ø¯Ø± Ø¸Ø±ÙÛŒØª Ú©Ø§Ù…Ù„ Ù…Ø¯ÛŒØ±ÛŒØª Ø±Ø§ Ø¯Ø§Ø±Ø¯. Ù¾Ø³ Ø§Ø² ÙˆØ±ÙˆØ¯ Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ú†Ù‡Ø±Ù‡Ù” Ø®ÙˆØ¯ Ø±Ø§ Ø«Ø¨Øª Ùˆ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¬Ø¯ÛŒØ¯ Ø±Ø§ Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ù†Ø¯.</p>
        <button type="submit" class="auth-submit">ÙˆØ±ÙˆØ¯ Ø³Ø§Ø²Ù†Ø¯Ù‡</button>
      </form>
      <div class="camera-instruct">
        <strong>Ø±Ø§Ù‡Ù†Ù…Ø§:</strong> Ø¨Ø±Ø§ÛŒ Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª ØªØµÙˆÛŒØ±ÛŒØŒ Ø§Ø¨ØªØ¯Ø§ Ø¯Ø± Ø³Ø§Ù…Ø§Ù†Ù‡ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ú©Ø§Ø±Ø¨Ø± Ø¹Ø§Ø¯ÛŒ Ø±Ø§ Ø«Ø¨Øª Ùˆ ØµÙˆØ±ØªØ´Ø§Ù† Ø±Ø§ Ø¶Ø¨Ø· Ú©Ù†ÛŒØ¯. Ù¾Ø³ Ø§Ø² ÙˆØ±ÙˆØ¯ØŒ Ø±ÙˆÛŒ Â«Ø«Ø¨Øª Ú†Ù‡Ø±Ù‡Â» Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯.
      </div>
    </div>
    <div class="auth-content" data-content="userFaceLogin">
      <h2 class="panel-title">ÙˆØ±ÙˆØ¯ Ú©Ø§Ø±Ø¨Ø± Ø¹Ø§Ø¯ÛŒ</h2>
      <p class="auth-tip">Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¹Ø§Ø¯ÛŒ ØªÙ†Ù‡Ø§ Ø¨Ø§ ØªØ´Ø®ÛŒØµ Ú†Ù‡Ø±Ù‡ ÙˆØ§Ø±Ø¯ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯. Ø§Ø¨ØªØ¯Ø§ Ø¯ÙˆØ±Ø¨ÛŒÙ† Ø±Ø§ Ø¢Ù…Ø§Ø¯Ù‡ Ú©Ù†ÛŒØ¯ Ùˆ Ø³Ù¾Ø³ Ø±ÙˆÛŒ Â«Ø´Ø±ÙˆØ¹ ØªØ´Ø®ÛŒØµ Ú†Ù‡Ø±Ù‡Â» Ø¨Ø²Ù†ÛŒØ¯ ÛŒØ§ ØªØµÙˆÛŒØ± Ú†Ù‡Ø±Ù‡Ù” Ø®ÙˆØ¯ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.</p>
      <div class="actions">
        <button type="button" class="outline-btn" onclick="prepareCamera()">ğŸ¥ Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø¯ÙˆØ±Ø¨ÛŒÙ†</button>
        <button type="button" onclick="startFaceLogin()">Ø´Ø±ÙˆØ¹ ØªØ´Ø®ÛŒØµ Ú†Ù‡Ø±Ù‡</button>
      </div>
      <div class="camera-instruct">
        Ø¯Ø± ØµÙˆØ±Øª ØªÙ…Ø§ÛŒÙ„ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø¹Ú©Ø³ Ú†Ù‡Ø±Ù‡Ù” Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ú©Ù†ÛŒØ¯:
        <input type="file" id="userLoginPhoto" accept="image/*" onchange="loginUserByPhoto(event)" style="margin-top:8px;" />
      </div>
    </div>
  </div>
</div>
<div id="appContainer" class="app-container hidden">
  <div class="app-top">
    <header>Ø²Ø¨Ø§Ù† Ø¨Ø§ÛŒÙ†Ø±ÛŒ Ù¾Ø§Ø±Ø¯ÛŒØ³</header>
    <div class="user-meta-box">
      <span id="currentUserLabel">---</span>
      <button type="button" class="logout-btn fixed-btn" onclick="logout()">Ø®Ø±ÙˆØ¬</button>
    </div>
  </div>
  <div id="gearButton" class="gear-btn" title="Ù†Ù…Ø§ÛŒØ´/Ù…Ø®ÙÛŒ ØªÙ†Ø¸ÛŒÙ…Ø§Øª" onclick="toggleSettings()">âš™ï¸</div>
  <div class="top-box">
    <textarea id="inputText" placeholder="Ù…ØªÙ† ÛŒØ§ Ú©Ø¯ Ø¨Ø§ÛŒÙ†Ø±ÛŒ Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯..." rows="5" dir="ltr"></textarea>
    <div class="actions" dir="ltr">
      <button onclick="processText()">ğŸ”„ Ø±Ù…Ø²Ú¯Ø°Ø§Ø±ÛŒ Ø¨Ù‡ Ø¨Ø§ÛŒÙ†Ø±ÛŒ</button>
      <button onclick="decodeBinary()">ğŸ”“ ØªØ¨Ø¯ÛŒÙ„ Ø¨Ù‡ Ù…ØªÙ†</button>
      <button onclick="pasteInput()">ğŸ“¥ paste</button>
      <button onclick="copyOutput()">ğŸ“‹ copy</button>
    </div>
    <div id="outputBox" dir="auto"></div>
  </div>
  <canvas id="bitScene" width="600" height="300"></canvas>
  <div id="bitLight" aria-live="polite" aria-label="Ú†Ø±Ø§Øº ÙˆØ¶Ø¹ÛŒØª Ø¨ÛŒØªâ€ŒÙ‡Ø§">
    <span>ÙˆØ¶Ø¹ÛŒØª Ø¨ÛŒØª:</span>
    <div id="bitZeroLight" class="bit-circle"></div>
    <div id="bitOneLight" class="bit-circle"></div>
  </div>
  <section class="stego-box">
    <h2>Ø§Ø³ØªÚ¯Ø§Ù†ÙˆÚ¯Ø±Ø§ÙÛŒ â€” Ø¬Ø§Ø³Ø§Ø²ÛŒ Ùˆ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ú©Ø¯</h2>
    <p class="stego-description">
      Ø¯Ø± Ø§ÛŒÙ† Ø¨Ø®Ø´ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ù…ØªÙ† ÛŒØ§ Ú©Ø¯ Ø¯Ù„Ø®ÙˆØ§Ù‡ Ø±Ø§ Ø¯Ø§Ø®Ù„ ØªØµÙˆÛŒØ± Ù¾Ù†Ù‡Ø§Ù† (LSB) Ú©Ù†ÛŒØ¯ Ùˆ Ù†Ø³Ø®Ù‡Ù” Ø¬Ø¯ÛŒØ¯ Ø±Ø§ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ú©Ù†ÛŒØ¯. Ù‡Ù…Ú†Ù†ÛŒÙ† Ø§Ù…Ú©Ø§Ù† Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù¾ÛŒØ§Ù… Ø§Ø² ØªØµØ§ÙˆÛŒØ± Ø±Ù…Ø²Ú¯Ø°Ø§Ø±ÛŒâ€ŒØ´Ø¯Ù‡ Ùˆ ØªØ±Ø¬Ù…Ù‡Ù” Ø®ÙˆØ¯Ú©Ø§Ø± Ù…ØªÙ† Ø§Ø³ØªØ®Ø±Ø§Ø¬â€ŒØ´Ø¯Ù‡ Ø¨Ù‡ ÙØ§Ø±Ø³ÛŒ Ø¨Ø±Ø§ÛŒ ØªÙ…Ø§Ù…ÛŒ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† ÙØ±Ø§Ù‡Ù… Ø§Ø³Øª.
    </p>
    <div class="stego-grid">
      <div class="stego-column">
        <h3>Ø¬Ø§Ø³Ø§Ø²ÛŒ Ú©Ø¯ Ø¯Ø± ØªØµÙˆÛŒØ±</h3>
        <label>ØªØµÙˆÛŒØ± ÙˆØ±ÙˆØ¯ÛŒ:
          <input type="file" id="stegoInputImage" accept="image/png,image/jpeg" />
        </label>
        <label>Ù…ØªÙ†/Ú©Ø¯ Ù…ÙˆØ±Ø¯Ù†Ø¸Ø±:
          <textarea id="stegoMessage" class="stego-textarea" placeholder="Ù…ØªÙ† ÛŒØ§ Ú©Ø¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯..."></textarea>
        </label>
        <button onclick="embedCodeInImage()">Ø¬Ø§Ø³Ø§Ø²ÛŒ Ùˆ Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø¯Ø§Ù†Ù„ÙˆØ¯</button>
        <div id="stegoResultContainer" class="stego-result hidden">
          <img id="stegoResultImage" alt="ØªØµÙˆÛŒØ± Ø­Ø§ÙˆÛŒ Ú©Ø¯" />
          <a id="downloadStegoLink" class="download-link" href="#" download>â¬‡ï¸ Ø¯Ø§Ù†Ù„ÙˆØ¯ ØªØµÙˆÛŒØ± Ø­Ø§ÙˆÛŒ Ú©Ø¯</a>
        </div>
      </div>
      <div class="stego-column">
        <h3>Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ùˆ ØªØ±Ø¬Ù…Ù‡</h3>
        <label>ØªØµÙˆÛŒØ± Ø­Ø§ÙˆÛŒ Ú©Ø¯:
          <input type="file" id="stegoDecodeImage" accept="image/png,image/jpeg" />
        </label>
        <button onclick="extractCodeFromImage()">Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù¾ÛŒØ§Ù…</button>
        <label>Ù¾ÛŒØ§Ù… Ø§Ø³ØªØ®Ø±Ø§Ø¬â€ŒØ´Ø¯Ù‡:
          <textarea id="stegoExtractedMessage" class="stego-result" readonly></textarea>
        </label>
        <div class="actions">
          <button class="outline-btn" onclick="translateExtractedMessage()">ğŸŒ ØªØ±Ø¬Ù…Ù‡ Ø¨Ù‡ ÙØ§Ø±Ø³ÛŒ</button>
        </div>
        <textarea id="stegoTranslatedMessage" class="stego-result" placeholder="ØªØ±Ø¬Ù…Ù‡Ù” Ù¾ÛŒØ§Ù… Ø¯Ø± Ø§ÛŒÙ†Ø¬Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯." readonly></textarea>
      </div>
    </div>
  </section>
  <section id="creatorPanel" class="creator-panel">
    <div class="assistant-box" id="motherAssistantBox">
      <h4>Ø¯Ø³ØªÛŒØ§Ø± Ù…Ø¯ÛŒØ±ÛŒØªÛŒ</h4>
      <p id="assistantGreeting">Ù…Ù‡Ø±Ø§Ù† Ø¹Ø²ÛŒØ² Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒ Ø¨Ù‡ Ø³Ø§Ù…Ø§Ù†Ù‡Ù” Ù¾Ø§Ø±Ø¯ÛŒØ³! ğŸŒŸ</p>
      <div class="status-row" id="assistantStats"></div>
      <ul>
        <li>Ø¨Ø±Ø§ÛŒ Ø«Ø¨Øª Ú†Ù‡Ø±Ù‡Ù” Ø®ÙˆØ¯ ÛŒØ§ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†ØŒ Ø§Ø² Ø¯ÙˆØ±Ø¨ÛŒÙ† Ø¨Ø§Ù„Ø§ Ø³Ù…Øª Ú†Ù¾ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†.</li>
        <li>Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ÛŒ Ø³Ø§Ø²Ù†Ø¯Ù‡Ù” Ø¯ÙˆÙ… Ø¨Ø§ ÙˆØ¶Ø¹ÛŒØª Â«Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± ØªØ£ÛŒÛŒØ¯Â» Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.</li>
        <li>Ø¨Ø±Ø§ÛŒ Ù‡Ø± Ú©Ø§Ø±Ø¨Ø±ØŒ Ø¨Ø§ Ú©Ù„ÛŒÚ© Ø±ÙˆÛŒ Â«Ø«Ø¨Øª Ú†Ù‡Ø±Ù‡ Ø¨Ø§ Ø¯ÙˆØ±Ø¨ÛŒÙ†Â» Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø§Ù†Ø¬Ø§Ù… Ø¯Ù‡ÛŒ.</li>
      </ul>
      <div class="actions">
        <button type="button" onclick="enrollCreatorFace()">Ø«Ø¨Øª/Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ú†Ù‡Ø±Ù‡Ù” Ù…Ù†</button>
        <button type="button" class="outline-btn" onclick="toggleCameraPanel()">Ø¨Ø§Ø²/Ø¨Ø³ØªÙ‡ Ú©Ø±Ø¯Ù† Ù¾Ù†Ø¬Ø±Ù‡Ù” Ø¯ÙˆØ±Ø¨ÛŒÙ†</button>
      </div>
    </div>
    <div>
      <h3>Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†</h3>
      <form id="createUserForm" onsubmit="createAccount(event)">
        <label>Ù†ÙˆØ¹ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÛŒØ¯</label>
        <select id="newAccountRole" required>
          <option value="user">Ú©Ø§Ø±Ø¨Ø± Ø¹Ø§Ø¯ÛŒ</option>
          <option value="secondary">Ø³Ø§Ø²Ù†Ø¯Ù‡ Ø¯ÙˆÙ…</option>
        </select>
        <input type="text" id="newAccountUsername" placeholder="Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ" required />
        <input type="password" id="newAccountPassword" placeholder="Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±" required />
        <button type="submit">Ø§ÛŒØ¬Ø§Ø¯ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÛŒØ¯</button>
      </form>
    </div>
    <div class="actions">
      <label>
        Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¹Ú©Ø³ Ø¨Ø±Ø§ÛŒ Ø«Ø¨Øª Ú†Ù‡Ø±Ù‡Ù” Ú©Ø§Ø±Ø¨Ø±:
        <input type="file" id="creatorPhotoEnrollment" accept="image/*" onchange="enrollUserByPhoto(event)" />
      </label>
    </div>
    <div>
      <h3>Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø«Ø¨Øªâ€ŒØ´Ø¯Ù‡</h3>
      <div id="userList" class="creator-user-list"></div>
    </div>
    <div>
      <h3>Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ÛŒ Ù…Ø¹Ù„Ù‚ Ø³Ø§Ø²Ù†Ø¯Ù‡Ù” Ø¯ÙˆÙ…</h3>
      <div id="pendingList" class="creator-user-list"></div>
    </div>
    <div>
      <h3>Ù†Ø´Ø³Øªâ€ŒÙ‡Ø§ÛŒ ÙØ¹Ø§Ù„</h3>
      <div id="activeSessions" class="creator-user-list"></div>
    </div>
    <div>
      <h3>ØªØ§Ø±ÛŒØ®Ú†Ù‡Ù” ÙˆØ±ÙˆØ¯ Ùˆ Ø®Ø±ÙˆØ¬</h3>
      <div id="historyLog"></div>
    </div>
  </section>
</div>
<div id="cameraPanel" class="camera-panel hidden">
  <div class="camera-header">
    <span>Ø¯ÙˆØ±Ø¨ÛŒÙ† Ù†Ø¸Ø§Ø±Øª Ú†Ù‡Ø±Ù‡</span>
    <button type="button" class="mini-btn" onclick="toggleCameraPanel()">Ú©Ù…ÛŒÙ†Ù‡</button>
  </div>
  <video id="liveVideo" autoplay muted playsinline></video>
  <p id="cameraStatus">Ø¨Ø±Ø§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ù‚Ø§Ø¨Ù„ÛŒØª ØªØ´Ø®ÛŒØµ Ú†Ù‡Ø±Ù‡ØŒ Ø±ÙˆÛŒ Â«Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø¯ÙˆØ±Ø¨ÛŒÙ†Â» Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯.</p>
  <div class="actions">
    <button type="button" onclick="captureFaceDescriptor()">Ø«Ø¨Øª Ú†Ù‡Ø±Ù‡ Ø¨Ø§ Ø¯ÙˆØ±Ø¨ÛŒÙ†</button>
    <button type="button" class="outline-btn" onclick="stopCamera()">ØªÙˆÙ‚Ù Ø¯ÙˆØ±Ø¨ÛŒÙ†</button>
  </div>
</div>
<div class="settings-panel" id="settingsPanel">
  <h3>ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù¾ÛŒØ´Ø±ÙØªÙ‡</h3>
  <label>Ø³Ø±Ø¹Øª ØªØ§ÛŒÙ¾ (Ù…ÛŒÙ„ÛŒâ€ŒØ«Ø§Ù†ÛŒÙ‡):
    <input type="number" id="typeSpeed" value="50" min="1" max="1000000000" step="10" />
  </label>
  <label>Ø±Ù†Ú¯ Ø¨ÛŒØª ØµÙØ±:
    <input type="color" id="colorZero" value="#00aaff" />
  </label>
  <label>Ø±Ù†Ú¯ Ø¨ÛŒØª ÛŒÚ©:
    <input type="color" id="colorOne" value="#ffff00" />
  </label>
  <label>Ø§Ù†Ø¯Ø§Ø²Ù‡ Ú©Ø±Ù‡â€ŒÙ‡Ø§:
    <input type="number" id="sphereSize" value="0.2" step="0.05" min="0.05" max="1" />
  </label>
  <label>Ú†Ú¯Ø§Ù„ÛŒ Ø¨ÛŒØª:
    <input type="number" id="bitDensity" value="1" step="1" min="1" max="5" />
  </label>
  <label>Ø³Ø±Ø¹Øª Ø­Ø±Ú©Øª Ø¨ÛŒØª:
    <input type="number" id="bitSpeed" value="0.01" step="0.005" min="0" max="0.05" />
  </label>
  <button class="close-btn" onclick="toggleSettings()">âœ–ï¸ Ø¨Ø³ØªÙ†</button>
</div>
<canvas id="stegoCanvas" class="hidden"></canvas>
<script defer src="https://cdn.jsdelivr.net/npm/@vladmandic/face-api/dist/face-api.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/155/three.min.js"></script>
<script>
/* ---------- Ø«Ø§Ø¨Øªâ€ŒÙ‡Ø§ ---------- */
const STORAGE_KEY = 'pardisBinaryAccounts';
const HISTORY_KEY = 'pardisSessionHistory';
const DEFAULT_CREATOR = { username: 'mehran_creator', password: 'Pardis@Face2025' };
const FACE_MODEL_URL = 'https://cdn.jsdelivr.net/npm/@vladmandic/face-api/model/';
const FACE_MATCH_THRESHOLD = 0.48;

/* ---------- ÙˆØ¶Ø¹ÛŒØª ---------- */
let accounts = [];
let currentUser = null;
let modelsReady = false;
let cameraReady = false;
let videoStream = null;
let activeSessionId = null;
let sessionHistory = [];

/* ---------- Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ ---------- */
document.addEventListener('DOMContentLoaded', async () => {
  accounts = loadAccounts();
  sessionHistory = loadHistory();
  await preloadDefaultCreator();
  accounts = loadAccounts();
  initializeAuth();
  updateCreatorPanel();
  refreshAssistantStats();
});

/* ---------- Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª Ùˆ Ù†Ù‚Ø´â€ŒÙ‡Ø§ ---------- */
function initializeAuth() {
  switchAuthTab('creatorLogin');
  setCameraStatus('Ø¨Ø±Ø§ÛŒ Ø´Ø±ÙˆØ¹ØŒ Ø±ÙˆÛŒ Â«Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø¯ÙˆØ±Ø¨ÛŒÙ†Â» Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯ Ùˆ Ø§Ø¬Ø§Ø²Ù‡ Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ø¯Ù‡ÛŒØ¯.');
}

function switchAuthTab(target) {
  document.querySelectorAll('.auth-tab').forEach(tab => tab.classList.toggle('active', tab.dataset.tab === target));
  document.querySelectorAll('.auth-content').forEach(content => content.classList.toggle('active', content.dataset.content === target));
}

function loadAccounts() {
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    return raw ? JSON.parse(raw) : [];
  } catch (err) {
    console.error('Ø®Ø·Ø§ Ø¯Ø± Ø®ÙˆØ§Ù†Ø¯Ù† Ø­Ø³Ø§Ø¨â€ŒÙ‡Ø§', err);
    return [];
  }
}

function loadHistory() {
  try {
    const raw = localStorage.getItem(HISTORY_KEY);
    return raw ? JSON.parse(raw) : [];
  } catch (err) {
    console.error('Ø®Ø·Ø§ Ø¯Ø± ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ù†Ø´Ø³Øª', err);
    return [];
  }
}

function saveAccounts() {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(accounts));
}

function saveHistory() {
  localStorage.setItem(HISTORY_KEY, JSON.stringify(sessionHistory));
}

async function preloadDefaultCreator() {
  const exists = accounts.some(acc => acc.role === 'mother');
  if (exists) return;
  const passwordHash = await hashString(DEFAULT_CREATOR.password);
  accounts.push({
    username: DEFAULT_CREATOR.username,
    passwordHash,
    role: 'mother',
    creatorId: null,
    faceDescriptor: null,
    createdAt: Date.now(),
    systemGenerated: true,
    pending: false
  });
  saveAccounts();
}

async function hashString(value) {
  const encoder = new TextEncoder();
  const data = encoder.encode(value);
  const hashBuffer = await crypto.subtle.digest('SHA-256', data);
  return Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2,'0')).join('');
}

function ensureAuthenticated() {
  if (!currentUser) {
    alert('Ù„Ø·ÙØ§Ù‹ Ø§Ø¨ØªØ¯Ø§ ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯.');
    return false;
  }
  return true;
}

function setActiveUser(account) {
  currentUser = account;
  activeSessionId = Date.now();
  document.getElementById('currentUserLabel').textContent = `${account.username} â€¢ ${translateRole(account.role)}`;
  document.getElementById('authOverlay').classList.add('hidden');
  document.getElementById('appContainer').classList.remove('hidden');
  if (account.role === 'mother') {
    document.getElementById('creatorPanel').classList.add('visible');
    document.getElementById('assistantGreeting').textContent = 'Ù…Ù‡Ø±Ø§Ù† Ø¹Ø²ÛŒØ² Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒ Ø¨Ù‡ Ø³Ø§Ù…Ø§Ù†Ù‡Ù” Ù¾Ø§Ø±Ø¯ÛŒØ³! ğŸŒŸ';
  } else if (account.role === 'secondary') {
    document.getElementById('creatorPanel').classList.add('visible');
    document.getElementById('assistantGreeting').textContent = 'Ø¨Ù‡ Ù…Ø¯ÛŒØ±ÛŒØª Ø§Ù…Ù† Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯. Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ÛŒ Ø´Ù…Ø§ Ù¾Ø³ Ø§Ø² ØªØ£ÛŒÛŒØ¯ Ù…Ù‡Ø±Ø§Ù† ÙØ¹Ø§Ù„ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯.';
  } else {
    document.getElementById('creatorPanel').classList.remove('visible');
  }
  logSession('login');
  updateCreatorPanel();
  refreshAssistantStats();
  alert(`Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯ ${account.username}`);
}

function translateRole(role) {
  if (role === 'mother') return 'Ø³Ø§Ø²Ù†Ø¯Ù‡ Ù…Ø§Ø¯Ø±';
  if (role === 'secondary') return 'Ø³Ø§Ø²Ù†Ø¯Ù‡ Ø¯ÙˆÙ…';
  return 'Ú©Ø§Ø±Ø¨Ø± Ø¹Ø§Ø¯ÛŒ';
}

function logout() {
  if (!currentUser) return;
  logSession('logout');
  currentUser = null;
  activeSessionId = null;
  stopCamera();
  document.getElementById('authOverlay').classList.remove('hidden');
  document.getElementById('appContainer').classList.add('hidden');
  document.getElementById('creatorPanel').classList.remove('visible');
  switchAuthTab('creatorLogin');
}

async function loginCreator(event) {
  event.preventDefault();
  const username = document.getElementById('creatorLoginUsername').value.trim();
  const password = document.getElementById('creatorLoginPassword').value;
  const passwordHash = await hashString(password);
  const account = accounts.find(acc => (acc.role === 'mother' || acc.role === 'secondary') && acc.username === username && acc.passwordHash === passwordHash);
  if (!account) {
    alert('Ø§Ø·Ù„Ø§Ø¹Ø§Øª ÙˆØ±ÙˆØ¯ ØµØ­ÛŒØ­ Ù†ÛŒØ³Øª ÛŒØ§ Ø­Ø³Ø§Ø¨ Ø´Ù…Ø§ ØªØ£ÛŒÛŒØ¯ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.');
    return;
  }
  if (account.pending) {
    alert('Ø§ÛŒÙ† Ø­Ø³Ø§Ø¨ Ù‡Ù†ÙˆØ² ØªÙˆØ³Ø· Ø³Ø§Ø²Ù†Ø¯Ù‡ Ù…Ø§Ø¯Ø± ØªØ£ÛŒÛŒØ¯ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.');
    return;
  }
  setActiveUser(account);
  if (account.role === 'mother') {
    alert('Ù…Ù‡Ø±Ø§Ù† Ø¹Ø²ÛŒØ² Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒ Ø¨Ù‡ Ø³Ø§Ù…Ø§Ù†Ù‡Ù” Ù¾Ø§Ø±Ø¯ÛŒØ³!');
  }
  document.getElementById('creatorLoginForm').reset();
}

async function loginUserByPhoto(event) {
  const file = event.target.files[0];
  if (!file) return;
  try {
    await ensureFaceApiReady(false);
    const descriptor = await getDescriptorFromImageFile(file);
    if (!descriptor) {
      alert('Ú†Ù‡Ø±Ù‡â€ŒØ§ÛŒ Ø¯Ø± ØªØµÙˆÛŒØ± ÛŒØ§ÙØª Ù†Ø´Ø¯.');
      return;
    }
    await authenticateFace(descriptor);
  } catch (err) {
    alert('ÙˆØ±ÙˆØ¯ Ø¨Ø§ Ø¹Ú©Ø³ Ù…Ù…Ú©Ù† Ù†Ø´Ø¯: ' + err.message);
  } finally {
    event.target.value = '';
  }
}

async function startFaceLogin() {
  try {
    await ensureFaceApiReady(true);
    alert('Ù„Ø·ÙØ§Ù‹ ØµÙˆØ±Øª Ø®ÙˆØ¯ Ø±Ø§ Ù…Ù‚Ø§Ø¨Ù„ Ø¯ÙˆØ±Ø¨ÛŒÙ† Ù†Ú¯Ù‡ Ø¯Ø§Ø±ÛŒØ¯.');
    const descriptor = await captureFaceDescriptor();
    if (!descriptor) {
      alert('Ú†Ù‡Ø±Ù‡â€ŒØ§ÛŒ Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ù†Ø´Ø¯.');
      return;
    }
    await authenticateFace(descriptor);
  } catch (err) {
    alert('ÙˆØ±ÙˆØ¯ Ø¨Ø§ Ú†Ù‡Ø±Ù‡ Ù…Ù…Ú©Ù† Ù†Ø´Ø¯: ' + err.message);
  }
}

async function authenticateFace(descriptor) {
  const labeled = await buildLabeledDescriptors();
  if (!labeled.length) {
    alert('Ù‡ÛŒÚ† Ú©Ø§Ø±Ø¨Ø± Ø¹Ø§Ø¯ÛŒ Ø¨Ø§ Ú†Ù‡Ø±Ù‡Ù” Ø«Ø¨Øªâ€ŒØ´Ø¯Ù‡ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.');
    return;
  }
  const matcher = new faceapi.FaceMatcher(labeled, FACE_MATCH_THRESHOLD);
  const best = matcher.findBestMatch(descriptor);
  if (best.label === 'unknown') {
    alert('Ú†Ù‡Ø±Ù‡Ù” Ø´Ù…Ø§ Ø¯Ø± Ø³Ø§Ù…Ø§Ù†Ù‡ ÛŒØ§ÙØª Ù†Ø´Ø¯.');
    return;
  }
  const account = accounts.find(acc => acc.username === best.label && !acc.pending);
  if (!account) {
    alert('Ø­Ø³Ø§Ø¨ Ù…Ø±ØªØ¨Ø· Ø¨Ø§ Ø§ÛŒÙ† Ú†Ù‡Ø±Ù‡ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯ ÛŒØ§ ØªØ£ÛŒÛŒØ¯ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.');
    return;
  }
  setActiveUser(account);
  alert(`Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯ ${account.username}`);
}

function loadPendingAccounts(role) {
  return accounts.filter(acc => acc.role === role && acc.pending);
}

/* ---------- Ù…Ø¯ÛŒØ±ÛŒØª Ø­Ø³Ø§Ø¨â€ŒÙ‡Ø§ ---------- */
async function createAccount(event) {
  event.preventDefault();
  if (!currentUser || (currentUser.role !== 'mother' && currentUser.role !== 'secondary')) {
    alert('Ø¯Ø³ØªØ±Ø³ÛŒ Ù…Ø¬Ø§Ø² Ù†ÛŒØ³Øª.');
    return;
  }
  const username = document.getElementById('newAccountUsername').value.trim();
  const password = document.getElementById('newAccountPassword').value;
  const role = document.getElementById('newAccountRole').value;
  if (!username || !password) {
    alert('Ø§Ø·Ù„Ø§Ø¹Ø§Øª ØªÚ©Ù…ÛŒÙ„ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.');
    return;
  }
  if (accounts.some(acc => acc.username === username)) {
    alert('Ø§ÛŒÙ† Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ Ù‚Ø¨Ù„Ø§Ù‹ Ø«Ø¨Øª Ø´Ø¯Ù‡ Ø§Ø³Øª.');
    return;
  }
  const passwordHash = await hashString(password);
  const newAccount = {
    username,
    passwordHash,
    role,
    creatorId: currentUser.username,
    faceDescriptor: null,
    createdAt: Date.now(),
    systemGenerated: false,
    pending: role === 'secondary' || currentUser.role === 'secondary'
  };
  accounts.push(newAccount);
  saveAccounts();
  updateCreatorPanel();
  refreshAssistantStats();
  document.getElementById('createUserForm').reset();
  if (newAccount.pending) {
    alert('Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÛŒØ¯ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯ Ùˆ Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± ØªØ£ÛŒÛŒØ¯ Ø³Ø§Ø²Ù†Ø¯Ù‡Ù” Ù…Ø§Ø¯Ø± Ø§Ø³Øª.');
  } else {
    alert('Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÛŒØ¯ Ø§ÛŒØ¬Ø§Ø¯ Ú¯Ø±Ø¯ÛŒØ¯.');
  }
}

function approveAccount(username) {
  const account = accounts.find(acc => acc.username === username);
  if (!account) return;
  account.pending = false;
  saveAccounts();
  updateCreatorPanel();
  refreshAssistantStats();
  alert(`Ø­Ø³Ø§Ø¨ ${username} ØªØ£ÛŒÛŒØ¯ Ø´Ø¯.`);
}

function rejectAccount(username) {
  accounts = accounts.filter(acc => acc.username !== username);
  saveAccounts();
  updateCreatorPanel();
  refreshAssistantStats();
  alert(`Ø­Ø³Ø§Ø¨ ${username} Ø­Ø°Ù Ø´Ø¯.`);
}

/* ---------- ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ù†Ø´Ø³Øª ---------- */
function logSession(type) {
  if (!currentUser || !activeSessionId) return;
  if (type === 'login') {
    sessionHistory.push({
      sessionId: activeSessionId,
      username: currentUser.username,
      role: currentUser.role,
      loginAt: new Date().toISOString(),
      logoutAt: null,
      durationSeconds: null
    });
  }
  if (type === 'logout') {
    const record = sessionHistory.find(entry => entry.sessionId === activeSessionId);
    if (record && !record.logoutAt) {
      record.logoutAt = new Date().toISOString();
      const diff = (new Date(record.logoutAt) - new Date(record.loginAt)) / 1000;
      record.durationSeconds = Math.round(diff);
    }
  }
  saveHistory();
  updateCreatorPanel();
  refreshAssistantStats();
}

/* ---------- Ú†Ù‡Ø±Ù‡ ---------- */
async function enrollCreatorFace() {
  if (!currentUser || currentUser.role === 'user') {
    alert('ØªÙ†Ù‡Ø§ Ø³Ø§Ø²Ù†Ø¯Ú¯Ø§Ù† Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ù†Ø¯ Ú†Ù‡Ø±Ù‡ Ø«Ø¨Øª Ú©Ù†Ù†Ø¯.');
    return;
  }
  try {
    await ensureFaceApiReady(true);
    alert('Ù„Ø·ÙØ§Ù‹ ØµÙˆØ±Øª Ø®ÙˆØ¯ Ø±Ø§ Ù…Ù‚Ø§Ø¨Ù„ Ø¯ÙˆØ±Ø¨ÛŒÙ† Ù‚Ø±Ø§Ø± Ø¯Ù‡ÛŒØ¯.');
    const descriptor = await captureFaceDescriptor();
    if (!descriptor) return alert('Ú†Ù‡Ø±Ù‡â€ŒØ§ÛŒ Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ù†Ø´Ø¯.');
    const idx = accounts.findIndex(acc => acc.username === currentUser.username);
    if (idx >= 0) {
      accounts[idx].faceDescriptor = descriptor;
      saveAccounts();
      alert('Ú†Ù‡Ø±Ù‡ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯.');
    }
  } catch (err) {
    alert('Ø«Ø¨Øª Ú†Ù‡Ø±Ù‡ Ù…ÙˆÙÙ‚ Ù†Ø¨ÙˆØ¯: ' + err.message);
  }
}

async function enrollUserByPhoto(e) {
  const file = e.target.files[0];
  if (!file) return;
  if (!currentUser || currentUser.role === 'user') {
    alert('Ø§ÛŒÙ† Ù‚Ø§Ø¨Ù„ÛŒØª Ù…Ø®ØµÙˆØµ Ø³Ø§Ø²Ù†Ø¯Ú¯Ø§Ù† Ø§Ø³Øª.');
    e.target.value = '';
    return;
  }
  try {
    await ensureFaceApiReady(false);
    const descriptor = await getDescriptorFromImageFile(file);
    if (!descriptor) { alert('Ú†Ù‡Ø±Ù‡â€ŒØ§ÛŒ Ø¯Ø± ØªØµÙˆÛŒØ± ÛŒØ§ÙØª Ù†Ø´Ø¯.'); e.target.value = ''; return; }
    const username = prompt('Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ ÙØ±Ø¯ÛŒ Ú©Ù‡ Ø¨Ø§ÛŒØ¯ Ú†Ù‡Ø±Ù‡Ù” Ø§Ùˆ Ø«Ø¨Øª Ø´ÙˆØ¯ØŸ');
    if (!username) { e.target.value = ''; return; }
    const account = accounts.find(acc => acc.username === username);
    if (!account) { alert('Ú©Ø§Ø±Ø¨Ø± ÛŒØ§ÙØª Ù†Ø´Ø¯.'); e.target.value = ''; return; }
    account.faceDescriptor = descriptor;
    if (currentUser.role === 'secondary' && account.role === 'user') {
      account.pending = true;
      alert('Ú†Ù‡Ø±Ù‡ Ø«Ø¨Øª Ø´Ø¯ Ø§Ù…Ø§ Ù†ÛŒØ§Ø² Ø¨Ù‡ ØªØ£ÛŒÛŒØ¯ Ø³Ø§Ø²Ù†Ø¯Ù‡Ù” Ù…Ø§Ø¯Ø± Ø¯Ø§Ø±Ø¯.');
    } else {
      account.pending = false;
      alert('Ú†Ù‡Ø±Ù‡Ù” Ú©Ø§Ø±Ø¨Ø± Ø«Ø¨Øª Ø´Ø¯.');
    }
    saveAccounts();
    updateCreatorPanel();
    refreshAssistantStats();
  } catch (err) {
    alert('Ø«Ø¨Øª Ú†Ù‡Ø±Ù‡ Ø§Ø² ØªØµÙˆÛŒØ± Ù…Ù…Ú©Ù† Ù†Ø´Ø¯: ' + err.message);
  } finally {
    e.target.value = '';
  }
}

/* ---------- Ø¯ÙˆØ±Ø¨ÛŒÙ† ---------- */
async function ensureFaceApiReady(requireCamera = true) {
  if (!modelsReady) {
    setCameraStatus('Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù…Ø¯Ù„â€ŒÙ‡Ø§ÛŒ ØªØ´Ø®ÛŒØµ Ú†Ù‡Ø±Ù‡...');
    await Promise.all([
      faceapi.nets.tinyFaceDetector.loadFromUri(FACE_MODEL_URL),
      faceapi.nets.faceLandmark68Net.loadFromUri(FACE_MODEL_URL),
      faceapi.nets.faceRecognitionNet.loadFromUri(FACE_MODEL_URL)
    ]);
    modelsReady = true;
    setCameraStatus('Ù…Ø¯Ù„â€ŒÙ‡Ø§ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø¯Ù†Ø¯.');
  }
  if (requireCamera && !cameraReady) {
    await startCamera();
  }
}

async function startCamera() {
  try {
    videoStream = await navigator.mediaDevices.getUserMedia({ video: true });
    const video = document.getElementById('liveVideo');
    video.srcObject = videoStream;
    cameraReady = true;
    document.getElementById('cameraPanel').classList.remove('hidden');
    setCameraStatus('Ø¯ÙˆØ±Ø¨ÛŒÙ† ÙØ¹Ø§Ù„ Ø§Ø³Øª. Ø¨Ø±Ø§ÛŒ Ø«Ø¨Øª Ú†Ù‡Ø±Ù‡ Ù†Ø²Ø¯ÛŒÚ© Ø´ÙˆÛŒØ¯.');
  } catch (err) {
    setCameraStatus('Ø¯ÙˆØ±Ø¨ÛŒÙ† Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ù†ÛŒØ³Øª: ' + err.message);
    throw err;
  }
}

function stopCamera() {
  if (!videoStream) return;
  videoStream.getTracks().forEach(track => track.stop());
  videoStream = null;
  cameraReady = false;
  document.getElementById('liveVideo').srcObject = null;
  setCameraStatus('Ø¯ÙˆØ±Ø¨ÛŒÙ† Ù…ØªÙˆÙ‚Ù Ø´Ø¯.');
}

function setCameraStatus(text) {
  document.getElementById('cameraStatus').textContent = text;
}

function toggleCameraPanel() {
  const panel = document.getElementById('cameraPanel');
  panel.classList.toggle('hidden');
}

async function captureFaceDescriptor() {
  if (!cameraReady || !videoStream) {
    await startCamera();
  }
  const video = document.getElementById('liveVideo');
  const detection = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptor();
  if (!detection) {
    alert('Ú†Ù‡Ø±Ù‡â€ŒØ§ÛŒ Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ù†Ø´Ø¯. Ú©Ù…ÛŒ Ù†Ø²Ø¯ÛŒÚ©â€ŒØªØ± Ø´ÙˆÛŒØ¯ ÛŒØ§ Ù†ÙˆØ± Ø±Ø§ ØªÙ†Ø¸ÛŒÙ… Ú©Ù†ÛŒØ¯.');
    return null;
  }
  return Array.from(detection.descriptor);
}

async function getDescriptorFromImageFile(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = async () => {
      const img = await faceapi.fetchImage(reader.result);
      const detection = await faceapi.detectSingleFace(img, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks().withFaceDescriptor();
      resolve(detection ? Array.from(detection.descriptor) : null);
    };
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

async function buildLabeledDescriptors() {
  const labeledDescriptors = [];
  for (const account of accounts) {
    if (!account.faceDescriptor || account.role !== 'user' || account.pending) continue;
    labeledDescriptors.push(new faceapi.LabeledFaceDescriptors(account.username, [new Float32Array(account.faceDescriptor)]));
  }
  return labeledDescriptors;
}

/* ---------- Ù…Ø¯ÛŒØ±ÛŒØª UI ---------- */
function updateCreatorPanel() {
  const panel = document.getElementById('creatorPanel');
  if (!currentUser || (currentUser.role !== 'mother' && currentUser.role !== 'secondary')) {
    panel.classList.remove('visible');
    return;
  }
  const userList = document.getElementById('userList');
  userList.innerHTML = '';
  accounts.filter(acc => acc.role !== 'mother').forEach(acc => {
    const card = document.createElement('div');
    card.className = 'user-card';
    const head = document.createElement('div');
    head.className = 'card-head';
    head.innerHTML = `<strong>${acc.username}</strong> <span class="role ${acc.pending ? 'pending' : ''}">${acc.pending ? 'Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± ØªØ£ÛŒÛŒØ¯' : translateRole(acc.role)}</span>`;
    const meta = document.createElement('div');
    meta.className = 'meta';
    meta.innerHTML = `
      <span>Ø«Ø¨Øª Ú†Ù‡Ø±Ù‡: ${acc.faceDescriptor ? 'âœ…' : 'âŒ'}</span>
      <span>Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯Ù‡: ${new Date(acc.createdAt).toLocaleString('fa-IR')}</span>
      <span>ØªÙˆØ³Ø·: ${acc.creatorId || 'Ø³ÛŒØ³ØªÙ…'}</span>
    `;
    card.append(head, meta);
    const actions = document.createElement('div');
    actions.className = 'actions';
    if (currentUser.role === 'mother' || !acc.pending) {
      const camBtn = document.createElement('button');
      camBtn.textContent = 'Ø«Ø¨Øª Ú†Ù‡Ø±Ù‡ Ø¨Ø§ Ø¯ÙˆØ±Ø¨ÛŒÙ†';
      camBtn.onclick = async () => {
        await ensureFaceApiReady(true);
        alert('Ù„Ø·ÙØ§Ù‹ ØµÙˆØ±Øª Ú©Ø§Ø±Ø¨Ø± Ø±Ø§ Ù…Ù‚Ø§Ø¨Ù„ Ø¯ÙˆØ±Ø¨ÛŒÙ† Ù‚Ø±Ø§Ø± Ø¯Ù‡ÛŒØ¯.');
        const descriptor = await captureFaceDescriptor();
        if (descriptor) {
          acc.faceDescriptor = descriptor;
          acc.pending = false;
          saveAccounts();
          updateCreatorPanel();
          refreshAssistantStats();
          alert('Ú†Ù‡Ø±Ù‡ Ø«Ø¨Øª Ø´Ø¯.');
        }
      };
      actions.appendChild(camBtn);
    }
    if (currentUser.role === 'mother') {
      const deleteBtn = document.createElement('button');
      deleteBtn.className = 'outline-btn';
      deleteBtn.textContent = 'Ø­Ø°Ù Ø­Ø³Ø§Ø¨';
      deleteBtn.onclick = () => {
        if (confirm(`Ø­Ø°Ù Ø­Ø³Ø§Ø¨ ${acc.username}ØŸ`)) {
          accounts = accounts.filter(a => a.username !== acc.username);
          saveAccounts();
          updateCreatorPanel();
          refreshAssistantStats();
        }
      };
      actions.appendChild(deleteBtn);
    }
    card.appendChild(actions);
    userList.appendChild(card);
  });

  const pendingList = document.getElementById('pendingList');
  pendingList.innerHTML = '';
  if (currentUser.role === 'mother') {
    const pendingAccounts = accounts.filter(acc => acc.pending);
    if (!pendingAccounts.length) {
      pendingList.innerHTML = '<p class="empty-hint">Ù…ÙˆØ±Ø¯ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.</p>';
    } else {
      pendingAccounts.forEach(acc => {
        const card = document.createElement('div');
        card.className = 'user-card';
        card.innerHTML = `
          <div class="card-head">
            <strong>${acc.username}</strong>
            <span class="role pending">Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± ØªØ£ÛŒÛŒØ¯</span>
          </div>
          <div class="meta">
            <span>Ù†Ù‚Ø´: ${translateRole(acc.role)}</span>
            <span>Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯Ù‡: ${new Date(acc.createdAt).toLocaleString('fa-IR')}</span>
            <span>Ø³Ø§Ø²Ù†Ø¯Ù‡: ${acc.creatorId || 'Ù†Ø§Ù…Ø´Ø®Øµ'}</span>
          </div>
          <div class="actions">
            <button onclick="approveAccount('${acc.username}')">ØªØ£ÛŒÛŒØ¯</button>
            <button class="outline-btn" onclick="rejectAccount('${acc.username}')">Ø±Ø¯ Ùˆ Ø­Ø°Ù</button>
          </div>
        `;
        pendingList.appendChild(card);
      });
    }
  } else {
    pendingList.innerHTML = '<p class="empty-hint">ØªÙ†Ù‡Ø§ Ø³Ø§Ø²Ù†Ø¯Ù‡Ù” Ù…Ø§Ø¯Ø± Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ Ø±Ø§ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ú©Ù†Ø¯.</p>';
  }

  const activeContainer = document.getElementById('activeSessions');
  const nowActive = sessionHistory.filter(entry => !entry.logoutAt);
  activeContainer.innerHTML = '';
  if (!nowActive.length) {
    activeContainer.innerHTML = '<p class="empty-hint">Ù†Ø´Ø³Øª ÙØ¹Ø§Ù„ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</p>';
  } else {
    nowActive.forEach(entry => {
      const card = document.createElement('div');
      card.className = 'user-card';
      card.innerHTML = `
        <div class="card-head">
          <strong>${entry.username}</strong>
          <span class="role">${translateRole(entry.role)}</span>
        </div>
        <div class="meta">
          <span>ÙˆØ±ÙˆØ¯: ${new Date(entry.loginAt).toLocaleString('fa-IR')}</span>
        </div>
      `;
      activeContainer.appendChild(card);
    });
  }

  const historyLog = document.getElementById('historyLog');
  if (!sessionHistory.length) {
    historyLog.innerHTML = '<p class="empty-hint">ØªØ§Ø±ÛŒØ®Ú†Ù‡â€ŒØ§ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.</p>';
  } else {
    const table = document.createElement('table');
    table.className = 'history-table';
    table.innerHTML = `
      <thead>
        <tr>
          <th>Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ</th>
          <th>Ù†Ù‚Ø´</th>
          <th>Ø²Ù…Ø§Ù† ÙˆØ±ÙˆØ¯</th>
          <th>Ø²Ù…Ø§Ù† Ø®Ø±ÙˆØ¬</th>
          <th>Ù…Ø¯Øª (Ø«Ø§Ù†ÛŒÙ‡)</th>
        </tr>
      </thead>
      <tbody>
        ${sessionHistory.map(entry => `
          <tr>
            <td>${entry.username}</td>
            <td>${translateRole(entry.role)}</td>
            <td>${entry.loginAt ? new Date(entry.loginAt).toLocaleString('fa-IR') : '-'}</td>
            <td>${entry.logoutAt ? new Date(entry.logoutAt).toLocaleString('fa-IR') : 'Ø¯Ø± Ø­Ø§Ù„ Ø§Ø³ØªÙØ§Ø¯Ù‡'}</td>
            <td>${entry.durationSeconds ?? '-'}</td>
          </tr>
        `).join('')}
      </tbody>
    `;
    historyLog.innerHTML = '';
    historyLog.appendChild(table);
  }
}

function refreshAssistantStats() {
  const statsBox = document.getElementById('assistantStats');
  if (!statsBox) return;
  const totalUsers = accounts.length;
  const totalMothers = accounts.filter(acc => acc.role === 'mother').length;
  const totalSecondary = accounts.filter(acc => acc.role === 'secondary').length;
  const totalNormal = accounts.filter(acc => acc.role === 'user').length;
  const pendingCount = accounts.filter(acc => acc.pending).length;
  const activeSessions = sessionHistory.filter(entry => !entry.logoutAt).length;
  const usedFace = accounts.filter(acc => acc.faceDescriptor).length;
  statsBox.innerHTML = `
    <span>ğŸ‘¥ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ú©Ù„: ${totalUsers}</span>
    <span>ğŸ§­ Ø³Ø§Ø²Ù†Ø¯Ù‡ Ø¯ÙˆÙ…: ${totalSecondary}</span>
    <span>ğŸ™‚ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¹Ø§Ø¯ÛŒ: ${totalNormal}</span>
    <span>ğŸŸ¢ Ù†Ø´Ø³Øª ÙØ¹Ø§Ù„: ${activeSessions}</span>
    <span>â³ Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±: ${pendingCount}</span>
    <span>ğŸ“· Ú†Ù‡Ø±Ù‡ Ø«Ø¨Øªâ€ŒØ´Ø¯Ù‡: ${usedFace}</span>
  `;
}

/* ---------- Steganography ---------- */
function embedCodeInImage() {
  if (!ensureAuthenticated()) return;
  const fileInput = document.getElementById('stegoInputImage');
  const message = document.getElementById('stegoMessage').value;
  if (!fileInput.files.length) {
    alert('Ø§Ø¨ØªØ¯Ø§ ÛŒÚ© ØªØµÙˆÛŒØ± Ø¨Ø±Ø§ÛŒ Ø¬Ø§Ø³Ø§Ø²ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.');
    return;
  }
  if (!message) {
    alert('Ù…ØªÙ† ÛŒØ§ Ú©Ø¯ Ù…ÙˆØ±Ø¯Ù†Ø¸Ø± Ø¨Ø±Ø§ÛŒ Ø¬Ø§Ø³Ø§Ø²ÛŒ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.');
    return;
  }
  const file = fileInput.files[0];
  const image = new Image();
  const imageUrl = URL.createObjectURL(file);
  image.onload = () => {
    URL.revokeObjectURL(imageUrl);
    const canvas = document.getElementById('stegoCanvas');
    const ctx = canvas.getContext('2d');
    canvas.width = image.width;
    canvas.height = image.height;
    ctx.drawImage(image, 0, 0);
    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
    const binaryMessage = encodeMessageForStego(message);
    if (binaryMessage.length > imageData.data.length) {
      alert('Ù…ØªÙ† Ø§Ù†ØªØ®Ø§Ø¨ÛŒ Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† ØªØµÙˆÛŒØ± Ø®ÛŒÙ„ÛŒ Ø·ÙˆÙ„Ø§Ù†ÛŒ Ø§Ø³Øª. ØªØµÙˆÛŒØ± Ø¨Ø²Ø±Ú¯ØªØ±ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯ ÛŒØ§ Ù…ØªÙ† Ø±Ø§ Ú©ÙˆØªØ§Ù‡â€ŒØªØ± Ú©Ù†ÛŒØ¯.');
      return;
    }
    for (let i = 0; i < binaryMessage.length; i++) {
      imageData.data[i] = (imageData.data[i] & 0xFE) | Number(binaryMessage[i]);
    }
    ctx.putImageData(imageData, 0, 0);
    const dataUrl = canvas.toDataURL('image/png');
    document.getElementById('stegoResultImage').src = dataUrl;
    const downloadLink = document.getElementById('downloadStegoLink');
    downloadLink.href = dataUrl;
    downloadLink.download = `pardis-stego-${Date.now()}.png`;
    document.getElementById('stegoResultContainer').classList.remove('hidden');
    alert('Ú©Ø¯ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¯Ø± ØªØµÙˆÛŒØ± Ø¬Ø§Ø³Ø§Ø²ÛŒ Ø´Ø¯.');
  };
  image.onerror = () => {
    URL.revokeObjectURL(imageUrl);
    alert('Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ØªØµÙˆÛŒØ± Ø¨Ø§ Ø®Ø·Ø§ Ù…ÙˆØ§Ø¬Ù‡ Ø´Ø¯.');
  };
  image.src = imageUrl;
}

function encodeMessageForStego(message) {
  const encoder = new TextEncoder();
  const data = encoder.encode(message);
  const lengthBytes = new Uint8Array(new Uint32Array([data.length]).buffer);
  let bits = '';
  lengthBytes.forEach(byte => bits += byte.toString(2).padStart(8,'0'));
  data.forEach(byte => bits += byte.toString(2).padStart(8,'0'));
  return bits;
}

function extractCodeFromImage() {
  if (!ensureAuthenticated()) return;
  const fileInput = document.getElementById('stegoDecodeImage');
  if (!fileInput.files.length) {
    alert('ØªØµÙˆÛŒØ± Ø±Ù…Ø²Ú¯Ø°Ø§Ø±ÛŒâ€ŒØ´Ø¯Ù‡ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.');
    return;
  }
  const file = fileInput.files[0];
  const image = new Image();
  const imageUrl = URL.createObjectURL(file);
  image.onload = () => {
    URL.revokeObjectURL(imageUrl);
    const canvas = document.getElementById('stegoCanvas');
    const ctx = canvas.getContext('2d');
    canvas.width = image.width;
    canvas.height = image.height;
    ctx.drawImage(image, 0, 0);
    const data = ctx.getImageData(0, 0, canvas.width, canvas.height).data;
    let bits = '';
    for (let i = 0; i < data.length; i++) {
      bits += (data[i] & 1).toString();
    }
    try {
      const message = decodeMessageFromBits(bits);
      document.getElementById('stegoExtractedMessage').value = message || 'Ù¾ÛŒØ§Ù…ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯.';
      if (message) alert('Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù…ØªÙ† Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯.');
      else alert('Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù…Ø¹ØªØ¨Ø±ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯.');
    } catch (err) {
      alert('Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù…ØªÙ† Ø¨Ø§ Ø®Ø·Ø§ Ø±ÙˆØ¨Ù‡â€ŒØ±Ùˆ Ø´Ø¯: ' + err.message);
    }
  };
  image.onerror = () => {
    URL.revokeObjectURL(imageUrl);
    alert('Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ØªØµÙˆÛŒØ± Ø¨Ø§ Ø®Ø·Ø§ Ù…ÙˆØ§Ø¬Ù‡ Ø´Ø¯.');
  };
  image.src = imageUrl;
}

function decodeMessageFromBits(bits) {
  if (bits.length < 32) throw new Error('Ø¯Ø§Ø¯Ù‡ Ú©Ø§ÙÛŒ Ø¨Ø±Ø§ÛŒ Ø®ÙˆØ§Ù†Ø¯Ù† Ø·ÙˆÙ„ Ù¾ÛŒØ§Ù… ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.');
  const lengthBits = bits.slice(0, 32);
  const messageLength = parseInt(lengthBits, 2);
  if (!Number.isFinite(messageLength) || messageLength <= 0) return '';
  const totalLength = 32 + messageLength * 8;
  if (totalLength > bits.length) throw new Error('Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ ØªØµÙˆÛŒØ± Ø¨Ø§ Ø·ÙˆÙ„ Ø§Ø¹Ù„Ø§Ù…â€ŒØ´Ø¯Ù‡ Ù…Ø·Ø§Ø¨Ù‚Øª Ù†Ø¯Ø§Ø±Ø¯.');
  const messageBits = bits.slice(32, totalLength);
  const bytes = [];
  for (let i = 0; i < messageLength; i++) {
    const byte = messageBits.slice(i * 8, (i + 1) * 8);
    bytes.push(parseInt(byte, 2));
  }
  return new TextDecoder().decode(new Uint8Array(bytes));
}

/* ---------- ØªØ±Ø¬Ù…Ù‡ ---------- */
function translateExtractedMessage() {
  if (!ensureAuthenticated()) return;
  const message = document.getElementById('stegoExtractedMessage').value.trim();
  if (!message || message === 'Ù¾ÛŒØ§Ù…ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯.') {
    alert('Ø§Ø¨ØªØ¯Ø§ Ø¨Ø§ÛŒØ¯ Ù¾ÛŒØ§Ù…ÛŒ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø´ÙˆØ¯.');
    return;
  }
  const translated = translateToPersian(message);
  document.getElementById('stegoTranslatedMessage').value = translated;
  alert('ØªØ±Ø¬Ù…Ù‡ Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯.');
}

function translateToPersian(text) {
  const dictionary = {
    'hello': 'Ø³Ù„Ø§Ù…',
    'world': 'Ø¯Ù†ÛŒØ§',
    'binary': 'Ø¨Ø§ÛŒÙ†Ø±ÛŒ',
    'code': 'Ú©Ø¯',
    'secret': 'Ù…Ø®ÙÛŒ',
    'steganography': 'Ø§Ø³ØªÚ¯Ø§Ù†ÙˆÚ¯Ø±Ø§ÙÛŒ',
    'user': 'Ú©Ø§Ø±Ø¨Ø±',
    'creator': 'Ø³Ø§Ø²Ù†Ø¯Ù‡',
    'login': 'ÙˆØ±ÙˆØ¯',
    'password': 'Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±',
    'success': 'Ù…ÙˆÙÙ‚ÛŒØª',
    'welcome': 'Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯'
  };
  return text.split(/\s+/).map(word => dictionary[word.toLowerCase()] || word).join(' ');
}

/* ---------- ØªØ¨Ø¯ÛŒÙ„ Ù…ØªÙ† Ùˆ Ø¨Ø§ÛŒÙ†Ø±ÛŒ ---------- */
function processText() {
  if (!ensureAuthenticated()) return;
  const text = document.getElementById('inputText').value;
  if (!text) { alert('Ù…ØªÙ†ÛŒ ÙˆØ§Ø±Ø¯ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.'); return; }
  const binary = textToBinary(text);
  animateBinary(binary);
  typeOutput(binary);
}

function textToBinary(txt) {
  let binary = '';
  for (let i = 0; i < txt.length; i++) {
    let code = txt.charCodeAt(i);
    binary += code.toString(2).padStart(16, '0');
  }
  return binary;
}

function decodeBinary() {
  if (!ensureAuthenticated()) return;
  let binary = document.getElementById('inputText').value.replace(/\s+/g, '');
  if (!binary) {
    alert('Ú©Ø¯ÛŒ Ø¨Ø±Ø§ÛŒ ØªØ¨Ø¯ÛŒÙ„ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯.');
    return;
  }
  if (binary.length % 16 !== 0) {
    alert('Ø·ÙˆÙ„ Ø±Ø´ØªÙ‡Ù” Ø¨Ø§ÛŒÙ†Ø±ÛŒ Ø¨Ø§ÛŒØ¯ Ù…Ø¶Ø±Ø¨ÛŒ Ø§Ø² Û±Û¶ Ø¨Ø§Ø´Ø¯.');
    return;
  }
  let text = '';
  for (let i = 0; i < binary.length; i += 16) {
    let chunk = binary.slice(i, i + 16);
    text += String.fromCharCode(parseInt(chunk, 2));
  }
  animateBinary(binary);
  typeOutput(text);
}

function typeOutput(result) {
  const output = document.getElementById('outputBox');
  output.textContent = '';
  const speed = parseInt(document.getElementById('typeSpeed').value, 10) || 50;
  let index = 0;
  const interval = setInterval(() => {
    if (index >= result.length) { clearInterval(interval); return; }
    output.textContent += result[index];
    index++;
  }, speed);
}

function copyOutput() {
  if (!ensureAuthenticated()) return;
  let text = document.getElementById('outputBox').textContent;
  if (!text) return alert('Ù…ØªÙ†ÛŒ Ø¨Ø±Ø§ÛŒ Ú©Ù¾ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯');
  navigator.clipboard.writeText(text).then(() => alert('Ú©Ù¾ÛŒ Ø´Ø¯ âœ…')).catch(() => alert('Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ú©Ù„ÛŒÙ¾â€ŒØ¨ÙˆØ±Ø¯ Ø§Ù…Ú©Ø§Ù†â€ŒÙ¾Ø°ÛŒØ± Ù†Ø¨ÙˆØ¯.'));
}

function pasteInput() {
  if (!ensureAuthenticated()) return;
  navigator.clipboard.readText().then(text => {
    document.getElementById('inputText').value = text;
  }).catch(() => {
    alert('Ø®ÙˆØ§Ù†Ø¯Ù† Ø§Ø² Ú©Ù„ÛŒÙ¾â€ŒØ¨ÙˆØ±Ø¯ Ø§Ù…Ú©Ø§Ù†â€ŒÙ¾Ø°ÛŒØ± Ù†Ø¨ÙˆØ¯.');
  });
}

/* ---------- Ø³Ù‡â€ŒØ¨Ø¹Ø¯ÛŒ ---------- */
let scene = new THREE.Scene();
let camera = new THREE.PerspectiveCamera(75, 600/300, 0.1, 1000);
let renderer = new THREE.WebGLRenderer({canvas: document.getElementById('bitScene'), alpha:true, antialias:true});
renderer.setSize(600, 300);
camera.position.z = 6;
let spheres = [];
let animationSpeed = 0.01;

function updateScene(binaryString) {
  spheres.forEach(sphere=>scene.remove(sphere));
  spheres = [];
  let colorZero = document.getElementById('colorZero').value;
  let colorOne = document.getElementById('colorOne').value;
  let sphereSize = parseFloat(document.getElementById('sphereSize').value) || 0.2;
  let density = parseInt(document.getElementById('bitDensity').value) || 1;
  let posXStart = -binaryString.length/(density*10)/2;
  for (let i = 0; i < binaryString.length; i += density) {
    let bit = binaryString[i];
    let geometry = new THREE.SphereGeometry(sphereSize, 20, 20);
    let material = new THREE.MeshBasicMaterial({color: bit === '0' ? colorZero : colorOne});
    let sphere = new THREE.Mesh(geometry, material);
    sphere.position.x = posXStart + (i / density) * 0.4;
    sphere.position.y = Math.sin(i/3) * 0.6;
    scene.add(sphere);
    spheres.push(sphere);
  }
  document.getElementById('bitZeroLight').classList.toggle('on-zero', binaryString.includes('0'));
  document.getElementById('bitOneLight').classList.toggle('on-one', binaryString.includes('1'));
}

function animateBinary(binaryString) {
  updateScene(binaryString);
}

function animate() {
  requestAnimationFrame(animate);
  spheres.forEach(sphere => {
    sphere.position.y += Math.sin(Date.now() * 0.001) * animationSpeed;
  });
  renderer.render(scene, camera);
}
animate();

function toggleSettings() {
  if (!ensureAuthenticated()) return;
  document.getElementById('settingsPanel').classList.toggle('show');
}

document.getElementById('bitSpeed').addEventListener('input', e => {
  animationSpeed = parseFloat(e.target.value);
});

/* ---------- Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ø³Ø§Ù…Ø§Ù†Ù‡ ---------- */
console.info(`Ù¾Ø§Ø±Ø¯ÛŒØ³ Ø¨Ø§ÛŒÙ†Ø±ÛŒ â€” Ù†Ø³Ø®Ù‡ Û´
â€¢ Ø³Ø§Ø²Ù†Ø¯Ù‡ Ù…Ø§Ø¯Ø±: Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ù…Ù„ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ùˆ Ù†Ø´Ø³Øªâ€ŒÙ‡Ø§.
â€¢ Ø³Ø§Ø²Ù†Ø¯Ù‡ Ø¯ÙˆÙ…: Ø§ÛŒØ¬Ø§Ø¯ Ú©Ø§Ø±Ø¨Ø± Ø¹Ø§Ø¯ÛŒ Ùˆ Ø«Ø¨Øª Ú†Ù‡Ø±Ù‡ (Ù†ÛŒØ§Ø²Ù…Ù†Ø¯ ØªØ£ÛŒÛŒØ¯ Ù…Ø§Ø¯Ø±).
â€¢ Ú©Ø§Ø±Ø¨Ø± Ø¹Ø§Ø¯ÛŒ: ÙˆØ±ÙˆØ¯ ØµØ±ÙØ§Ù‹ Ø¨Ø§ Ú†Ù‡Ø±Ù‡ Ùˆ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø§Ø¨Ø²Ø§Ø±Ù‡Ø§ÛŒ Ø±Ù…Ø²Ú¯Ø°Ø§Ø±ÛŒ/Ø§Ø³ØªÚ¯Ø§Ù†ÙˆÚ¯Ø±Ø§ÙÛŒ.
â€¢ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯: Ø§Ù†ØªÙ‚Ø§Ù„ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨Ù‡ Ø³Ø±ÙˆØ± Ø§Ù…Ù†ØŒ Ú©Ø´â€ŒÚ©Ø±Ø¯Ù† Ù…Ø¯Ù„â€ŒÙ‡Ø§ÛŒ ØªØ´Ø®ÛŒØµ Ú†Ù‡Ø±Ù‡ØŒ ØªÙ†Ø¸ÛŒÙ… Ø¢Ø³ØªØ§Ù†Ù‡Ù” ØªØ·Ø§Ø¨Ù‚ Ùˆ Ù†Ù…Ø§ÛŒØ´ Ø³ÛŒØ§Ø³Øª Ù…Ø¬ÙˆØ² Ø¯ÙˆØ±Ø¨ÛŒÙ†.`);

</script>
</body>
</html>
<!DOCTYPE html>
<html>
    <head>
        <title>Runtime Error</title>
        <meta name="viewport" content="width=device-width" />
        <style>
         body {font-family:"Verdana";font-weight:normal;font-size: .7em;color:black;} 
         p {font-family:"Verdana";font-weight:normal;color:black;margin-top: -5px}
         b {font-family:"Verdana";font-weight:bold;color:black;margin-top: -5px}
         H1 { font-family:"Verdana";font-weight:normal;font-size:18pt;color:red }
         H2 { font-family:"Verdana";font-weight:normal;font-size:14pt;color:maroon }
         pre {font-family:"Consolas","Lucida Console",Monospace;font-size:11pt;margin:0;padding:0.5em;line-height:14pt}
         .marker {font-weight: bold; color: black;text-decoration: none;}
         .version {color: gray;}
         .error {margin-bottom: 10px;}
         .expandable { text-decoration:underline; font-weight:bold; color:navy; cursor:hand; }
         @media screen and (max-width: 639px) {
          pre { width: 440px; overflow: auto; white-space: pre-wrap; word-wrap: break-word; }
         }
         @media screen and (max-width: 479px) {
          pre { width: 280px; }
         }
        </style>
    </head>

    <body bgcolor="white">

            <span><H1>Server Error in '/' Application.<hr width=100% size=1 color=silver></H1>

            <h2> <i>Runtime Error</i> </h2></span>

            <font face="Arial, Helvetica, Geneva, SunSans-Regular, sans-serif ">

            <b> Description: </b>An application error occurred on the server. The current custom error settings for this application prevent the details of the application error from being viewed remotely (for security reasons). It could, however, be viewed by browsers running on the local server machine.
            <br><br>

            <b>Details:</b> To enable the details of this specific error message to be viewable on remote machines, please create a &lt;customErrors&gt; tag within a &quot;web.config&quot; configuration file located in the root directory of the current web application. This &lt;customErrors&gt; tag should then have its &quot;mode&quot; attribute set to &quot;Off&quot;.<br><br>

            <table width=100% bgcolor="#ffffcc">
               <tr>
                  <td>
                      <code><pre>

&lt;!-- Web.Config Configuration File --&gt;

&lt;configuration&gt;
    &lt;system.web&gt;
        &lt;customErrors mode=&quot;Off&quot;/&gt;
    &lt;/system.web&gt;
&lt;/configuration&gt;</pre></code>

                  </td>
               </tr>
            </table>

            <br>

            <b>Notes:</b> The current error page you are seeing can be replaced by a custom error page by modifying the &quot;defaultRedirect&quot; attribute of the application&#39;s &lt;customErrors&gt; configuration tag to point to a custom error page URL.<br><br>

            <table width=100% bgcolor="#ffffcc">
               <tr>
                  <td>
                      <code><pre>

&lt;!-- Web.Config Configuration File --&gt;

&lt;configuration&gt;
    &lt;system.web&gt;
        &lt;customErrors mode=&quot;RemoteOnly&quot; defaultRedirect=&quot;mycustompage.htm&quot;/&gt;
    &lt;/system.web&gt;
&lt;/configuration&gt;</pre></code>

                  </td>
               </tr>
            </table>

            <br>

    </body>
</html>
